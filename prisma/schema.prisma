// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  name            String?
  phone           String?
  password        String?
  role            UserRole @default(CUSTOMER)
  isActive        Boolean  @default(true)
  isEmailVerified Boolean  @default(false)
  avatarUrl       String?
  lastLoginAt     DateTime?
  deletedAt       DateTime? // Soft delete timestamp
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Location Information
  city            String?
  state           String?
  country         String?   // Full country name
  countryCode     String?   // ISO country code (e.g., 'IN', 'US')
  currencyCode    String?   // ISO currency code (e.g., 'INR', 'USD')
  timezone        String?   // IANA timezone (e.g., 'Asia/Kolkata')
  locale          String?   // Language/locale (e.g., 'en-IN')

  // Relations
  vendorStaff     VendorStaff[]
  bookings        Booking[]
  teamMembers     TeamMember[]

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@index([deletedAt])
  @@index([countryCode])
  @@index([city])
  @@index([email, deletedAt, isActive]) // Composite index for login queries
  @@map("users")
}

model Vendor {
  id              String    @id @default(cuid())
  name            String    @unique
  slug            String    @unique
  description     String?
  logoUrl         String?
  website         String?
  email           String    @unique

  // Phone Information - Split for better normalization
  phoneCountryCode String?  // Country calling code (e.g., "+1", "+91")
  phoneNumber     String?   // Local phone number without country code

  isActive        Boolean   @default(true)
  autoApprove     Boolean   @default(false)
  onboardedAt     DateTime  @default(now())
  deletedAt       DateTime? // Soft delete timestamp

  // Address Information
  address         String?
  postalCode      String?
  country         String?   // Full country name
  state           String?   // State/province name
  city            String?   // City name

  // International Settings
  countryCode     String    // ISO country code
  currencyCode    String    // ISO currency code
  timezone        String    // IANA timezone
  locale          String    // Language/locale

  // Branding & Theming
  primaryColor    String?   @default("#3B82F6")
  secondaryColor  String?   @default("#64748B")
  accentColor     String?   @default("#F59E0B")

  // Dates
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  venues          Venue[]
  vendorStaff     VendorStaff[]
  vendorSettings  VendorSettings?

  @@index([slug])
  @@index([isActive])
  @@index([deletedAt])
  @@map("vendors")
}

model VendorStaff {
  id          String   @id @default(cuid())
  vendorId    String
  userId      String
  role        UserRole @default(VENDOR_STAFF)
  permissions String?  // JSON string for SQLite compatibility
  isActive    Boolean  @default(true)
  hiredAt     DateTime @default(now())

  // Relations
  vendor      Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([vendorId, userId])
  @@index([vendorId])
  @@index([userId])
  @@map("vendor_staff")
}

model VendorSettings {
  id                        String   @id @default(cuid())
  vendorId                  String   @unique
  advanceBookingDays        Int      @default(30)
  maxConcurrentBookings     Int      @default(10)
  requiresDeposit           Boolean  @default(false)
  basePrice                 Decimal  @default(1000)
  taxRate                   Decimal  @default(18.0)
  taxIncluded               Boolean  @default(false)
  taxId                     String?  // Tax ID number
  showBookingCalendar       Boolean  @default(true)
  showPricingPublicly       Boolean  @default(true)
  allowOnlinePayments       Boolean  @default(true)
  emailNotifications        Boolean  @default(true)
  bookingReminders          Boolean  @default(true)
  newBookingAlerts          Boolean  @default(true)
  autoApproval              Boolean  @default(false)
  
  // Granular notification settings (JSON)
  emailNotificationSettings String?  // JSON: { newBookings, bookingCancellations, paymentConfirmations, weeklyReports, marketingUpdates }
  smsNotificationSettings    String?  // JSON: { newBookings, bookingCancellations, urgentAlerts, silentHours }
  
  // Payment settings (JSON)
  paymentSettings           String?  // JSON: { acceptedPaymentMethods[], refundPolicy, preferredPaymentMethod, payoutSchedule }
  
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  // Relations
  vendor                    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@map("vendor_settings")
}

model Venue {
  id          String   @id @default(cuid())
  vendorId    String
  name        String
  description String?
  address     String?
  city        String?
  postalCode  String?
  latitude    Decimal?
  longitude   Decimal?
  phone       String?
  email       String?
  website     String?
  countryCode String?
  currencyCode String?
  timezone    String   @default("UTC")
  featuredImage String?
  isActive    Boolean  @default(true)
  deletedAt   DateTime? // Soft delete timestamp
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  vendor      Vendor     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  courts      Court[]
  operatingHours VenueOperatingHours[]

  @@index([vendorId])
  @@index([isActive])
  @@index([deletedAt])
  @@index([vendorId, isActive, deletedAt]) // Composite index for common venue queries
  @@index([city, countryCode]) // For location-based queries
  @@map("venues")
}

model VenueOperatingHours {
  id          String   @id @default(cuid())
  venueId     String
  dayOfWeek   Int      // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
  openingTime String   // HH:mm format
  closingTime String   // HH:mm format
  isOpen      Boolean  @default(true)

  // Relations
  venue       Venue @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@unique([venueId, dayOfWeek])
  @@map("venue_operating_hours")
}

model Court {
  id            String    @id @default(cuid())
  venueId       String
  sportId       String
  formatId      String?
  name          String
  courtNumber   String
  description   String?
  surface       String?
  pricePerHour  Decimal   @default(1000)
  isActive      Boolean   @default(true)
  maxPlayers    Int       @default(10)
  features      String?  // JSON array of court features
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  venue         Venue       @relation(fields: [venueId], references: [id], onDelete: Cascade)
  sport         SportType   @relation(fields: [sportId], references: [id], onDelete: Cascade)
  format        FormatType? @relation(fields: [formatId], references: [id], onDelete: SetNull)
  bookings      Booking[]

  @@unique([venueId, courtNumber])
  @@index([venueId])
  @@index([sportId])
  @@index([isActive])
  @@index([venueId, isActive]) // Composite index for common court queries
  @@index([sportId, isActive]) // For sport-based filtering
  @@index([venueId, sportId, isActive]) // For venue + sport filtering
  @@map("courts")
}

model SportType {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  icon        String?
  description String?
  teamSize    Int?
  duration    Int?     // Duration in minutes
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  courts      Court[]
  formats     FormatType[]
  teams       Team[]

  @@index([isActive])
  @@map("sport_types")
}

model FormatType {
  id          String   @id @default(cuid())
  sportId     String
  name        String
  displayName String
  description String?

  // Format Configuration
  minPlayers  Int
  maxPlayers  Int
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  sport       SportType @relation(fields: [sportId], references: [id], onDelete: Cascade)
  teams       Team[]
  courts      Court[]

  @@unique([sportId, name])
  @@index([sportId])
  @@map("format_types")
}

model Booking {
  id          String      @id @default(cuid())
  userId      String
  courtId     String
  date        DateTime
  startTime   DateTime
  endTime     DateTime
  totalAmount Decimal
  status      BookingStatus @default(PENDING)
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  court       Court       @relation(fields: [courtId], references: [id], onDelete: Cascade)
  payments    Payment[]

  @@index([userId])
  @@index([courtId])
  @@index([date])
  @@index([status])
  @@map("bookings")
}

model Payment {
  id          String       @id @default(cuid())
  bookingId   String
  userId      String
  amount      Decimal
  method      PaymentMethod
  status      PaymentStatus @default(PENDING)
  transactionId String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  booking     Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([userId])
  @@index([status])
  @@map("payments")
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  sportId     String
  formatId    String?
  city        String?
  maxPlayers  Int
  minPlayers  Int
  isActive    Boolean  @default(true)
  isRecruiting Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  sport       SportType   @relation(fields: [sportId], references: [id], onDelete: Cascade)
  format      FormatType? @relation(fields: [formatId], references: [id], onDelete: SetNull)
  members     TeamMember[]

  @@index([sportId])
  @@index([city])
  @@index([isActive])
  @@index([isRecruiting])
  @@map("teams")
}

model TeamMember {
  id       String     @id @default(cuid())
  teamId   String
  userId   String
  role     TeamRole   @default(MEMBER)
  isActive Boolean    @default(true)
  joinedAt DateTime   @default(now())

  // Relations
  team     Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user     User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

// ========================================
// ENUMS
// ========================================

enum UserRole {
  PLATFORM_ADMIN
  VENDOR_ADMIN
  VENDOR_STAFF
  CUSTOMER
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  REFUNDED
  NO_SHOW
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  UPI
  NET_BANKING
  WALLET
  CASH
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum TeamRole {
  ADMIN
  CAPTAIN
  PLAYER
  MEMBER
}